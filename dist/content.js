!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self)["api-to-interface"]=t()}(this,function(){const d=e=>e.substr(0,1).toUpperCase()+e.slice(1),u=e=>{var t=document.createElement("textarea");document.body.appendChild(t),t.value=e,t.select(),document.execCommand("copy"),document.body.removeChild(t)},h=e=>{var t=document.createElement("div"),r=(t.classList="to-ts-msg",document.createElement("div"));r.innerText=e.text||"success~",t.appendChild(r),document.body.appendChild(t),setTimeout(function(){t.classList="to-ts-msg is-leaving",t.addEventListener("transitionend",function(){document.body.contains(t)&&document.body.removeChild(t)})},2e3)},y=(r,e=" | ")=>((r=r instanceof Array?r:r.split(",")).forEach((e,t)=>{"integer"===e&&(r[t]="number")}),r.join(e)),r=new XMLHttpRequest,e=()=>{var e=window.location.pathname.replace(/\/project\/\d+\/interface\/api\//,"");const t=window.location.protocol+"//"+window.location.host+"/api/interface/get?id="+e;return new Promise(e=>{r.open("GET",t,!0),r.send(),r.onreadystatechange=()=>{4==r.readyState&&200==r.status&&e(r.responseText)}})},m={resBtn:{field:"res_body",innerText:"返回值转换"},bodyBtn:{field:"req_body_other",innerText:"Body参数转换"},queryBtn:{field:"req_query",innerText:"Query参数转换"}};class t{constructor(e){this.exportStr="",this.apiUrl=e,this.separator=";"}deepClone(e){var t,r=e instanceof Array?[]:{};for(t in e)e[t]&&"object"==typeof e[t]?r[t]=this.deepClone(e[t]):r[t]=e[t];return r}deepCloneToType(e){var t,r,n=e instanceof Array?[]:{};for(t in e)e[t]&&"object"==typeof e[t]?n[t]=this.deepCloneToType(e[t]):(r=typeof e[t],n[t]=this.judgeValueType(r));return n}judgeValueType(e){let t=e;switch(e){case"number":t="number";break;case"string":t="string";break;case"boolean":t="boolean";break;default:t="any"}return t}formatToTsInterface(n,o){let s=this.deepClone(n),t=(o=d(o),Object.keys(n).forEach(e=>{var t,r=""+o+d(e);"object"==typeof n[e]&&(n[e]instanceof Array?0===n[e].length?s[e]="any[]":"object"==typeof n[e][0]?(s[e]=r+"[]",this.formatToTsInterface(n[e][0],r)):(t=typeof n[e][0],s[e]=t+"[]"):(s[e]=r,this.formatToTsInterface(n[e],r)))}),"");Object.keys(s).forEach(e=>{t+=`
  ${e}: `+s[e]+this.separator}),this.generateExportStr(o,t)}jsonSchemaToTsInterface(e,t){let r=this.deepClone(e);for(var n in t=d(t),e){var o=""+t+d(n),{type:s,description:a,properties:i,items:c}=e[n];if("required"!==n&&(r[n]={type:y(s),description:a},r.required)&&r.required.includes(n)&&(r[n].required=!0),"object"===s&&(r[n].type=o),"array"===s){var p=c&&c.type?c.type:"any";switch(p){case"object":case"array":r[n].type=o+"[]",this.jsonSchemaToTsInterface(c.properties,o);break;default:r[n].type=p+"[]"}}i&&(this.jsonSchemaToTsInterface(i,o),delete r[n].properties)}let l="";Object.keys(r).forEach(e=>{r[e].description&&(l+=`
  /** ${r[e].description} */`),r[e].type&&(l+=`
  ${e}${r[e].required?"":"?"}: `+r[e].type+this.separator)}),this.generateExportStr(t,l)}queryToTsInterface(e,t){let n="";t=d(t),e.forEach(e=>{var{desc:e,name:t,required:r}=e;e&&(n+=`
 /** ${e} */`),n+=`
 ${t}${"1"===r?"":"?"}: string`+this.separator}),this.generateExportStr(t,n)}generateExportStr(e,t){this.exportStr="export interface "+e+" {"+t+"\n}\n\n"+this.exportStr}compile(e,t,r,n){switch(this.exportStr="",r){case"json_schema":this.jsonSchemaToTsInterface(e,t);break;case"form":case"query":this.queryToTsInterface(e,t);break;default:var o=this.deepCloneToType(e);this.formatToTsInterface(o,t)}return`/** ${n}-${this.apiUrl} */
`+this.exportStr}}const n=new class{constructor(){this.toTsCompile=new t(location.href)}createElementFun(e){var t=document.createElement(e.elem);return t.innerText=e.innerText||"",t.classList=e.classList||"",t.type=e.type||"",t}contentLoad(e){var e=e.target,t=this.createElementFun({classList:"to-ts"}),r=this.createBtnWrapper(),n=this.createSeparator(),o=this.createQueryBtn(),s=this.createBodyBtn(),a=this.createResBtn();t.appendChild(r),t.appendChild(n),t.appendChild(o),t.appendChild(s),t.appendChild(a),e.body.appendChild(t)}createBtnWrapper(){return this.createElementFun({elem:"h4",classList:"to-ts-title",innerText:"接口转为ts interface"})}createSeparator(){var e=this.createElementFun({elem:"input",type:"text",classList:"separator"}),t=this.createElementFun({elem:"div",classList:"separator-wrapper",innerText:"每行分隔符"});return t.appendChild(e),e.value=this.toTsCompile.separator,e.onblur=e=>{this.toTsCompile.separator=e.target.value},t}createResBtn(){const e=this.createElementFun({elem:"button",classList:"to-ts-res-btn",innerText:"返回值转换"});return e.onclick=()=>{this.clickCallBack(e,"resBtn")},e}createBodyBtn(){const e=this.createElementFun({elem:"button",classList:"to-ts-req-btn",innerText:"Body参数转换"});return e.onclick=()=>{this.clickCallBack(e,"bodyBtn")},e}createQueryBtn(){const e=this.createElementFun({elem:"button",classList:"to-ts-query-btn",innerText:"Query参数转换"});return e.onclick=()=>{this.clickCallBack(e,"queryBtn")},e}clickCallBack(p,l){p.innerText="转换中...",e().then(n=>{try{var o=(n=JSON.parse(n).data).title;let e=n[m[l].field],t=("string"==typeof e&&(e=new Function("return "+n[m[l].field])()),"");var s=n.path.replace(".do","").split("/"),a=s[s.length-1];let r=a;if(-1<a.indexOf("-")){const c=a.split("-");c.forEach((e,t)=>{0<t&&(c[t]=d(e))}),r=c.join("")}"resBtn"===l?(r+="Res",n.res_body_is_json_schema&&"json"===n.res_body_type&&(e=e.properties,t="json_schema")):"bodyBtn"===l?(r+="Body","form"===n.req_body_type?(e=n.req_body_form,t="form"):n.req_body_is_json_schema&&(e=e.properties,t="json_schema")):"queryBtn"===l&&(r+="Query",t="query");var i=this.toTsCompile.compile(e,r,t,o);u(i),p.innerText=m[l].innerText,h({text:"复制成功",type:"success"})}catch(e){console.error(e),p.innerText=m[l].innerText,h({text:"生成失败, 请检查是否有"+m[l].innerText,type:"error"})}})}};return document.addEventListener("DOMContentLoaded",function(e){n.contentLoad(e)}),n});
